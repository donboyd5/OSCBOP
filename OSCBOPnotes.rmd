---
title: "OSCBOP notes"
author: "Don Boyd"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 4
---

<!--- 
http://www.molecularecologist.com/2013/11/using-github-with-r-and-rstudio/

TO STOP TRACKING A FILE:
http://git-scm.com/docs/gitignore
add the filename to the gitignore file for the project

To stop tracking a file that is currently tracked, use 'git rm --cached'.
For example - open the git gui (right-click from Windows Explorer in the project directory) and do
  git rm --cached OSCBOPnotes.html
  where what follows "cached" is the name of the file to stop tracking

rmarkdown::render("E:/R/RPrograms/OSCBOP/OSCBOPnotes.Rmd", output_format ="html_document", output_dir="E:\\Temp", intermediates_dir="E:\\Temp")

rmarkdown::render("E:/R/RPrograms/OSCBOP/OSCBOPnotes.Rmd", output_format ="html_document")

-->

```{r globalOptions, include=FALSE}
# include=FALSE means don't put chunk output in the final output document, but still do run the code

# devtools::install_github("donboyd5/btools") # install btools if not already installed

# libraries I always want loaded
library(btools) # library that I created (see above for installation)
library(foreign) # various import and export routines - e.g., for reading Stata files
library(gdata) # for reading spreadsheets
library(ggplot2)
library(scales) # so we can use scales with ggplot2
library(plyr) # needed for ddply [but was it already loaded??]
library(reshape2)
library(tidyr)
library(dplyr) # always load AFTER plyr
library(knitr)

# next 2 are so that we can read and display screenshots, etc.
library(jpeg)
library(grid)

# define global chunk options, which can be overridden in individual chunks
opts_chunk$set(fig.width=9, fig.height=6.43, fig.path='Figs/', echo=FALSE, warning=FALSE, message=FALSE)
options(width=160) # set to 120 for html output, 80 for pdf output

```



```{r mainDefinitions, include=FALSE, cache=FALSE}
# note that when cache=TRUE it does not remember the functions that are loaded in the chunk, so use that option only for creating
# data (I think)
# source("E:\\R\\RPrograms\\BoydStartup.r", echo=FALSE)  # only needed for the getdata() function

# define directories
# dropdir <- "E:\\Dropbox\\PEW\\"

bopd <- "E:\\Data\\Projects\\OSC BOP\\"

fbdbd <- "E:\\Data\\Federal budget and spending\\FFY 2015\\Database\\"

# abc

# constants we'll almost always need    ####

# USASpending constants - file name prefixes
fngrants <- "_All_Grants_Full_"
fbdp <- "_All_DirectPayments_Full_"
fncon <- "_All_Contracts_Full_"
fnloans <- "_All_Loans_Full_"
fninsur <- "_All_Insurance_Full_"

usasver <- "20140515" # version number of latest set of USASpending files

# API keys
beaapikey <- "21F782AD-56A6-439D-B3D5-9A592F020E26"
censusapikey <- "b27cb41e46ffe3488af186dd80c64dce66bd5e87"

```

```{r downloads, eval=FALSE}
# download any needed files


# ```{r fig.width=1, fig.height=10}
# library(png)
# library(grid)
# img <- readPNG(path/to/your/image)
#  grid.raster(img)
# ```

```

# Possible approaches
Goal: Allocate as much of the federal budget as is practical – revenue and spending – to each of the individual 50 states, using “reasonable” methodologies.

Two possible approaches:

1. Foot the numbers to the federal budget – the formal data on receipts and disbursements, and the official budget deficit. Where data allow (rare), use actual information on how each component of the budget is distributed to individual states. In other cases “allocate” spending to individual states based on reasonable proxies.  (NOTE: When I use the term “federal budget” I am referring to a data source and a way of categorizing data. The term “budget” here does NOT mean that the numbers are budgeted or projected.) 
2. Use “disembodied” numbers from different data sources for major elements of the federal budget, and don’t worry too much if they do not add up to the federal budget precisely.

The attraction of the former is it allows us to get at the balance of payments concept but it forces us to come up with proxies to allocate the budget. The advantage of the latter is that it requires fewer assumptions, but then we don’t foot to the full budget. I believe the first approach is best for our purposes as long as we think we have reasonable proxies – an issue we currently are exploring.

## Authority, obligations or outlays?
Per the 1999 Moynihan report (p.109), "The dollar amounts reported by the Census Bureau in the CFFR report can represent either actual expenditures or obligations. As a general guide, the grants and procurement data in the CFFR report represent obligated funds, while the salaries, wages and direct payments show actual expenditures.""

## How the Moynihan report addressed this issue
Moynihan/KSG appear to have used a variant of #2: As far as I can tell, they added up all spending in CFFR, and treated that as the totality of federal spending, and then allocated a like amount of taxes (to force a balanced budget). That worked for them, I believe, because the CFFR accounted for about “four fifths” of federal outlays, per the 1999 fisc report. Per the Moynihan report:


* The calculations of Federal expenditures allocated to states are based on the reconciliation of two sources of data, the Consolidated Federal Funds Report, published by the Census Bureau, and the Budget of the United States Government, published by the Office of Management and Budget. While the Census Bureau does attempt to reconcile their data with the Federal budget, the two are not completely comparable. Over the past seven years, the Census measure of expenditures distributed domestically has accounted for about four fifths of total Federal outlays published by the Office of Management and Budget. Some areas of the budget, like foreign aid and some military spending, are spent overseas, so are not included in the Census data. No consistent methodology has been established to distribute other areas of spending such as net interest, deposit insurance or undistributed (by program) offsetting receipts. Finally, the amounts shown in the report for defense expenditures include all spending by the Department of Defense plus Department of Energy spending on defense-related activities and military retirement, disability payments, and other veterans’ benefits. (1999 Fisc Report, p.111)

## What Pew and NPP are doing
The National Priorities Project, and Pew, in their respective projects, are using the second approach. That is, they are not trying to add up to the full federal budget. This makes sense for their purposes because they are not comparing federal revenue to federal spending, and are not professing to allocate the entire federal budget to the 50 states.


# Federal budget overview
FFY 2013 ended Sept 30, 2013 and we have reasonably complete data, so this is the year to use.

The “Historical Tables” (http://www.whitehouse.gov/omb/budget/Historicals) are a key source of information on the federal budget. Here is a snapshot of recent years from HT Table 1.1. The federal budget deficit peaked at $1.3 trillion in FFY 2011 and fell to $680 billion in 2013. These are the official federal deficit numbers.

<img src="E:\\R\\RPrograms\\OSCBOP\\Images\\fedbud.png" />

Total spending in 2013 on this basis was $3.455 trillion.

When we look at USASpending we appear to come up about $450-500 billion short. The table below shows $2.5 trillion of spending, plus another $467 billion we know about from personnel data. The two together are about 87% of federal outlays.

<img src="E:\\R\\RPrograms\\OSCBOP\\Images\\usaspendingfy2013totals.jpg" />



```{r appendices, child=paste0("subGrants.Rmd"), eval=TRUE}
# don't put anything else here - it WILL NOT BE RUN!
```

```{r appendices, child=paste0("subAppendices.Rmd"), eval=FALSE}
# don't put anything else here - it WILL NOT BE RUN!
```

```{r appendices, child=paste0("subAppendices.Rmd"), eval=FALSE}
# don't put anything else here - it WILL NOT BE RUN!
```


```{r appendices, child=paste0("subAppendices.Rmd"), eval=FALSE}
# don't put anything else here - it WILL NOT BE RUN!
```



```{r, fig.width=6, fig.height=5, eval=FALSE}
# require(grDevices)
# dev.off()
# plot.new()
# set the x's and y's
xs <- c(0, 150) 
ys <- c(0, 100)
plot(xs, ys, type = "n", xlab = "", ylab = "", bty="n", axes=FALSE)
# image <- as.raster(matrix(0:1, ncol = 5, nrow = 3))
image <- readJPEG("E:\\R\\RPrograms\\OSCBOP\\Images\\temp.jpg")
rasterImage(image, xs[1], ys[1], xs[2], ys[2], interpolate = FALSE)
dev.off()

```


```{r fig.width=6.5, eval=FALSE}
# <img src="E:\\R\\RPrograms\\OSCBOP\\Images\\temp.jpg" height="200px" width="300px" /> put this in open text area
# <img src="E:\\R\\11khr.png" height="400px" width="300px" />
# quality below is lower than the html approach!
img <- readJPEG("E:\\R\\RPrograms\\OSCBOP\\Images\\temp.jpg")
grid.raster(img)
# plot.new()
# rasterImage(img, 100, 300, 150, 350, interpolate = FALSE)
# dev.off()

img2 <- readJPEG("E:\\R\\RPrograms\\OSCBOP\\Images\\temp.jpg", native=TRUE)
# rasterImage(img2, 100, 300, 150, 350)
# rasterImage(img2, 1.5, 1.5, 1.9, 1.8)
# plot(img2)
grid.raster(img2)
# plot(img, type="n")
#plot(1, type="n", xlim=c(100, 200), ylim=c(300, 350))
# rasterImage(test,100, 300, 150, 350)

#  library(EBImage)
#  > x = readImage('lena.gif') 
#  > display(x) 

```


